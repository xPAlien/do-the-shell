#!/usr/bin/env bash
# JustDo.sh ‚Äî v1.0
# Features:
# ‚úÖ Command correction for known tools
# ‚úÖ Friendly UX
# ‚úÖ Teach Mode (user-trained aliases)
# ‚úÖ Local analytics + stats
# ‚úÖ Brand voice alignment

CMD="$1"
shift || true

OS="$(uname -s)"
JUSTDO_HOME="$HOME/.justdo"
LOG_FILE="$JUSTDO_HOME/logs.txt"
CONFIG_FILE="$JUSTDO_HOME/config.txt"
TEACH_FILE="$JUSTDO_HOME/teach.db"

mkdir -p "$JUSTDO_HOME"
touch "$LOG_FILE"
touch "$TEACH_FILE"

analytics_enabled() {
  [[ -f "$CONFIG_FILE" ]] && grep -q "analytics=on" "$CONFIG_FILE"
}

log_event() {
  [[ ! "$(analytics_enabled)" ]] && return
  printf "%s | %s | user_input=\"%s\" | suggestion=\"%s\" | approved=\"%s\"\n" \
    "$(date '+%Y-%m-%d %H:%M:%S')" "$OS" "$1" "$2" "$3" >> "$LOG_FILE"
}

# Built-in corrections
declare -A FIX_MACOS=(
  ["ipconfig"]="ifconfig"
)
declare -A FIX_LINUX=(
  ["ipconfig"]="ip a"
)

resolve() {
  local c="$1"

  # first: user-learned matches
  local taught
  taught="$(grep "^$c=" "$TEACH_FILE" | cut -d'=' -f2)"
  [[ -n "$taught" ]] && { echo "$taught"; return; }

  # fallback to OS rules
  if [[ "$OS" == "Darwin" ]]; then echo "${FIX_MACOS[$c]}"; fi
  if [[ "$OS" == "Linux" ]]; then echo "${FIX_LINUX[$c]}"; fi
}

validate_command() {
  local cmd="$1"
  # Reject commands with shell metacharacters that could enable injection
  if [[ "$cmd" =~ [\;\|\&\$\`\<\>] ]] || [[ "$cmd" =~ \$\( ]]; then
    echo "‚ùå Invalid characters detected. Commands cannot contain: ; | & $ \` < > \$()"
    return 1
  fi
  # Reject commands that are too long
  if [[ ${#cmd} -gt 200 ]]; then
    echo "‚ùå Command too long (max 200 characters)"
    return 1
  fi
  return 0
}

teach_command() {
  local wrong="$1"
  local correct="$2"
  
  # Validate both the wrong command and the correct command
  if ! validate_command "$wrong"; then
    exit 1
  fi
  if ! validate_command "$correct"; then
    exit 1
  fi
  
  echo "$wrong=$correct" >> "$TEACH_FILE"
  echo "‚úÖ Thanks! I'll remember that."
}

print_stats() {
  if [[ ! -s "$LOG_FILE" ]]; then
    echo "üìä No usage stats yet ‚Äî try using justdo a bit more!"
    exit 0
  fi

  total=$(wc -l < "$LOG_FILE" | tr -d '[:space:]')
  corrected=$(grep -c 'suggestion="[^"]"' "$LOG_FILE")
  executed=$(grep -c 'approved="yes"' "$LOG_FILE")

  echo "üìä JustDo.sh Usage Stats"
  echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
  echo "Total commands: $total"
  [[ "$total" -gt 0 ]] && echo "Commands corrected: $corrected ($((100*corrected/total))%)"
  [[ "$corrected" -gt 0 ]] && echo "Commands run after fix: $executed ($((100*executed/corrected))%)"
  echo

  echo "üìà Top commands:"
  awk -F'user_input="' '{print $2}' "$LOG_FILE" | cut -d'"' -f1 |
    sort | uniq -c | sort -nr | head -5 | sed 's/^/  /'
  echo

  [[ "$(analytics_enabled)" ]] && echo "Analytics: ON" || echo "Analytics: OFF"
  echo "Log: $LOG_FILE"
  exit 0
}

case "$CMD" in
  stats) print_stats ;;
  analytics)
    case "$1" in
      on)  echo "analytics=on" > "$CONFIG_FILE";  echo "‚úÖ Analytics enabled" ;;
      off) rm -f "$CONFIG_FILE"; echo "üõë Analytics disabled" ;;
      status) [[ "$(analytics_enabled)" ]] && echo "üìä Analytics: ON" || echo "üìä Analytics: OFF" ;;
      *) echo "Usage: justdo analytics [on|off|status]" ;;
    esac
    exit 0
    ;;
  teach)
    wrong="$1"
    shift
    if [[ -z "$wrong" ]]; then
      echo "Usage: justdo teach <wrong_command> <correct_command>"
      exit 1
    fi
    if [[ -z "$1" ]]; then
      read -p "What should '$wrong' run instead?: " correct
    else
      correct="$*"
    fi
    teach_command "$wrong" "$correct"
    exit 0
    ;;
esac

if [[ -z "$CMD" ]]; then
  echo "Usage: justdo <command> [args]"
  exit 1
fi

FIX="$(resolve "$CMD")"

if [[ -n "$FIX" ]]; then
  echo "justdo is thinking..."
  echo "Fix suggestion: $FIX $*"
  read -p "Run this? (y/N): " ans

  approved="no"
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    # Validate the command before executing to prevent injection
    if ! validate_command "$FIX"; then
      echo "‚ùå Unsafe command detected. Please review your teach aliases."
      log_event "$CMD" "$FIX" "rejected"
      exit 1
    fi
    approved="yes"
    # Use command builtin instead of eval for safer execution
    command $FIX "$@"
  fi

  log_event "$CMD" "$FIX" "$approved"
  exit 0
fi

log_event "$CMD" "" "no"
echo "ü§î justdo doesn't know that one yet."
echo "Help me learn: justdo teach $CMD <correct_command>"
exit 1
